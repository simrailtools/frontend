syntax = "proto3";
package tools.simrail.backend;

option java_multiple_files = false;
option java_outer_classname = "EventBusProto";
option java_package = "tools.simrail.backend.common.proto";

// A geographical position.
message GeoPosition {
  double latitude = 1;
  double longitude = 2;
}

// Holds information about the signal that is ahead of a train. Note that the max_speed
// is not set in case that the signal displays a CLEAR aspect. For signals that display
// STOP, the max_speed is set to 0.
message SignalInfo {
  string name = 1;
  uint32 distance_meters = 2;
  optional uint32 max_speed_kmh = 3;
}

// Enumeration of the platforms that are supported by SimRail.
//  - STEAM: the user is playing on the PC (original) version
//  - XBOX : the user is playing on the XBox port of the game
enum UserPlatform {
  STEAM = 0;
  XBOX = 1;
}

// A user that is driving a train or dispatching a station. A user is uniquely identified by
// the union of the platform they are playing on (e.g. STEAM) and their corresponding user id.
message User {
  string id = 1;
  UserPlatform platform = 2;
}

// Holder for ids for a data element.
message IdHolder {
  string data_id = 1;
  string server_id = 2;
  string foreign_id = 3;
}

// Data about a journey that is active on a server.
message JourneyData {
  uint32 speed = 1;
  GeoPosition position = 2;
  optional User driver = 3;
  optional SignalInfo next_signal = 4;
  optional string current_point_id = 5;
}

// Data about a dispatch post on a server.
message DispatchPostData {
  optional User dispatcher = 1;
}

// Data about a registered sever.
message ServerData {
  bool online = 1;
  string scenery = 2;
  sint64 utc_offset_seconds = 3;
  optional string spoken_language = 4;
  repeated string tags = 5;
}

// Base data carried by all update frames. Note: the timestamp is generated using
// a monotonic clock to ensure that the timestamp of frames always increases (and are not
// influenced by system clock changes). However, this also means that the timestamp does
// NOT correlate to wall time and might be ahead or behind.
message BaseFrameData {
  uint64 timestamp = 1;
}

// An update frame for a journey. This frame is used to indicate that a journey was either
// updated or was newly added (can be detected by clients by checking if the id carried in
// the frame was stored locally already).
message JourneyUpdateFrame {
  BaseFrameData base_data = 1;
  IdHolder ids = 2;
  JourneyData journey_data = 3;
}

// A remove frame sent for a journey, indicating that the journey is no longer active.
message JourneyRemoveFrame {
  BaseFrameData base_data = 1;
  string journey_id = 2;
}

// An update frame for a dispatch post. This frame is used to indicate that a dispatch post
// was either updated or was newly added (can be detected by clients by checking if the id
// carried in the frame was stored locally already).
message DispatchPostUpdateFrame {
  BaseFrameData base_data = 1;
  IdHolder ids = 2;
  DispatchPostData dispatch_post_data = 3;
}

// A remove frame sent for a dispatch post, indicating that the dispatch post no longer exists.
message DispatchPostRemoveFrame {
  BaseFrameData base_data = 1;
  string post_id = 2;
}

// An update frame for a server. This frame is used to indicate that a server was either
// updated or was newly added (can be detected by clients by checking if the id carried in
// the frame was stored locally already).
message ServerUpdateFrame {
  BaseFrameData base_data = 1;
  IdHolder ids = 2;
  ServerData server_data = 3;
}

// A remove frame sent for a server, indicating that the server no longer exists.
message ServerRemoveFrame {
  BaseFrameData base_data = 1;
  string server_id = 2;
}
